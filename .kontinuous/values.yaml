global:
  pgSecretName: pg-app

app:
  ~chart: app
  imagePackage: app
  probesPath: /healthz
  containerPort: 3000
  ingress:
    enabled: false
  envFrom:
    - secretRef:
        name: "{{ .Values.global.pgSecretName }}"
    - secretRef:
        name: "staff"
    - secretRef:
        name: "egapro-secret"
    - secretRef:
        name: github-oauth
    - configMapRef:
        name: egapro
    - secretRef:
  env:
    - name: SENTRY_AUTH_TOKEN
      valueFrom:
        secretKeyRef:
          name: sentry
          key: SENTRY_AUTH_TOKEN
    - name: NEXT_PUBLIC_SENTRY_DSN
      valueFrom:
        secretKeyRef:
          name: sentry
          key: APP_SENTRY_DSN
    - name: POSTGRES_HOST
      valueFrom:
        secretKeyRef:
          name: "{{ .Values.global.pgSecretName }}"
          key: PGHOST
    - name: POSTGRES_DB
      valueFrom:
        secretKeyRef:
          name: "{{ .Values.global.pgSecretName }}"
          key: PGDATABASE
    - name: POSTGRES_PORT
      valueFrom:
        secretKeyRef:
          name: "{{ .Values.global.pgSecretName }}"
          key: PGPORT
    - name: POSTGRES_USER
      valueFrom:
        secretKeyRef:
          name: "{{ .Values.global.pgSecretName }}"
          key: PGUSER
    - name: POSTGRES_PASSWORD
      valueFrom:
        secretKeyRef:
          name: "{{ .Values.global.pgSecretName }}"
          key: PGPASSWORD
    - name: POSTGRES_SSLMODE
      valueFrom:
        secretKeyRef:
          name: "{{ .Values.global.pgSecretName }}"
          key: PGSSLMODE
    - name: SECURITY_JWT_SECRET
      valueFrom:
        secretKeyRef:
          name: "egapro-secret"
          key: EGAPRO_SECRET
  vars:
    NEXT_PUBLIC_EGAPRO_ENV: "{{ .Values.global.env }}"
    NEXTAUTH_URL: "https://{{ .Values.global.host }}/api/auth"
    OTEL_SDK_DISABLED: "true"
    REDIS_HOST: ""
    REDIS_PORT: ""

nginx:
  ~chart: app
  imagePackage: nginx
  host: "{{ .Values.global.host }}"
  ingress:
    customHeaders:
      "X-Frame-Options": "deny"
      "X-XSS-Protection": "1; mode=block"
      "X-Content-Type-Options": "nosniff"
      "Referrer-Policy": "no-referrer, strict-origin-when-cross-origin"
      "Permissions-Policy": "fullscreen=(), display-capture=(), camera=(), microphone=(), web-share=(), geolocation=()"
      "Cross-Origin-Embedder-Policy": "credentialless"
      "Cross-Origin-Resource-Policy": "cross-origin"
      "Cross-Origin-Opener-Policy": "same-origin"
    paths:
      - /
      - /api/auth(/|$)(.*)
      - /api/monitoring(/|$)(.*)
      - /index-egapro/recherche(/|$)(.*)
    pathType: ImplementationSpecific
  certSecretName: api-crt
  containerPort: 8080
  probesPath: /live
  livenessProbe:
    httpGet:
      path: /live
      port: 8080
  readinessProbe:
    httpGet:
      path: /ready
      port: 8080
  lifecycle:
    preStop:
      exec:
        command: ["/pre-stop.sh"]
  resources:
    requests:
      cpu: 30m
      memory: 256Mi
    limits:
      cpu: 2
      memory: 1G

pg:
  ~chart: pg
  volumes:
    - name: initdb
      configMap:
        name: egapro-init
  volumeMounts:
    - name: initdb
      mountPath: /docker-entrypoint-initdb.d

dbinit:
  ~chart: job
  image: postgres:15
  envFrom:
    - secretRef:
        name: pg-app
  command:
    - /bin/bash
    - -ec
    - |
      until pg_isready -h "$PGHOST" -U "$PGUSER"; do
        echo "Waiting for database..."
        sleep 2
      done


      psql -h "$PGHOST" -U "$PGUSER" -d "$PGDATABASE" -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO \"$PGUSER\";"
      psql -h "$PGHOST" -U "$PGUSER" -d "$PGDATABASE" -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO \"$PGUSER\";"
      psql -h "$PGHOST" -U "$PGUSER" -d "$PGDATABASE" -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO \"$PGUSER\";"
  restartPolicy: Never

egapro-init:
  ~chart: configmap
  data:
    egapro.sql: |
      CREATE EXTENSION IF NOT EXISTS unaccent;
      DO $BEGIN
          CREATE TEXT SEARCH CONFIGURATION ftdict (COPY=simple);
          ALTER TEXT SEARCH CONFIGURATION ftdict ALTER MAPPING FOR hword, hword_part, word WITH unaccent, simple;
      EXCEPTION
         WHEN unique_violation THEN
            NULL;  -- ignore error
      END;$;
      CREATE TABLE IF NOT EXISTS declaration
      (siren TEXT, year INT, modified_at TIMESTAMP WITH TIME ZONE, declared_at TIMESTAMP WITH TIME ZONE, declarant TEXT, data JSONB, draft JSONB, legacy JSONB, ft TSVECTOR,
      PRIMARY KEY (siren, year));
      CREATE TABLE IF NOT EXISTS representation_equilibree
      (siren TEXT, year INT, modified_at TIMESTAMP WITH TIME ZONE, declared_at TIMESTAMP WITH TIME ZONE, data JSONB, ft TSVECTOR,
      PRIMARY KEY (siren, year));
      CREATE TABLE IF NOT EXISTS simulation
      (id uuid PRIMARY KEY, modified_at TIMESTAMP WITH TIME ZONE, data JSONB);

      -- search declaration
      CREATE TABLE IF NOT EXISTS search
      (siren TEXT, year INT, declared_at TIMESTAMP WITH TIME ZONE, ft TSVECTOR, region VARCHAR(2), departement VARCHAR(3), section_naf CHAR, note INT,
      PRIMARY KEY (siren, year));
      ALTER TABLE search DROP CONSTRAINT IF EXISTS declaration_exists;
      ALTER TABLE search ADD CONSTRAINT declaration_exists FOREIGN KEY (siren,year) REFERENCES declaration(siren,year) ON DELETE CASCADE ON UPDATE CASCADE;

      -- search representation equilibree
      CREATE TABLE IF NOT EXISTS search_representation_equilibree
      (siren TEXT, year INT, declared_at TIMESTAMP WITH TIME ZONE, ft TSVECTOR, region VARCHAR(2), departement VARCHAR(3), section_naf CHAR,
      PRIMARY KEY (siren, year));
      ALTER TABLE search_representation_equilibree DROP CONSTRAINT IF EXISTS representation_equilibree_exists;
      ALTER TABLE search_representation_equilibree ADD CONSTRAINT representation_equilibree_exists FOREIGN KEY (siren,year) REFERENCES representation_equilibree(siren,year) ON DELETE CASCADE ON UPDATE CASCADE;

      CREATE TABLE IF NOT EXISTS archive
      (siren TEXT, year INT, at TIMESTAMP WITH TIME ZONE DEFAULT NOW(), by TEXT, ip INET, data JSONB);
      CREATE TABLE IF NOT EXISTS ownership (siren TEXT, email TEXT, PRIMARY KEY (siren, email));

      --
      -- indexes
      --

      CREATE INDEX IF NOT EXISTS idx_effectifs ON declaration ((data->'entreprise'->'effectifs'->>'tranche'));
      CREATE INDEX IF NOT EXISTS idx_status ON declaration (declared_at) WHERE declared_at IS NOT NULL;
      CREATE INDEX IF NOT EXISTS idx_ft ON search USING GIN (ft);
      CREATE INDEX IF NOT EXISTS idx_region ON search(region);
      CREATE INDEX IF NOT EXISTS idx_departement ON search(departement);
      CREATE INDEX IF NOT EXISTS idx_naf ON search(section_naf);
      CREATE INDEX IF NOT EXISTS idx_declared_at ON search (declared_at);
      CREATE INDEX IF NOT EXISTS idx_email ON representation_equilibree((data->'dÃ©clarant'->>'email'));
      CREATE INDEX IF NOT EXISTS idx_siren ON representation_equilibree(siren);

files:
  ~chart: app
  # image: ghcr.io/socialgouv/docker/nginx:7.0.1
  imagePackage: files
  vars:
    WHITELIST_IP: "94.23.250.213,37.187.27.197,37.187.137.149,217.182.225.117,217.182.225.113,217.182.142.112,51.38.59.32,51.254.44.90"
    AUTH_PASSWD_FILE: /secrets/basic-auth.passwd
    TRUSTED_PROXY_IP: "20.74.10.146"
    FILES_PUBLIC: index-egalite-fh.xlsx,dgt-export-representation.xlsx
    FILES_RESTRICTED: dgt.xlsx,dgt-representation.xlsx,full.ndjson,indexes.csv
    ROOT_PATH: /mnt/files
  containerPort: 8080
  probesPort: 8080
  host: "{{ .Values.global.host }}"
  .ingress.enabled: false
  volumes:
    - name: files
      persistentVolumeClaim:
        claimName: files
    - name: nginx-auth
      secret:
        secretName: basic-auth
        items:
          - key: auth
            path: basic-auth.passwd
  replicas: 1 # mandatory because volume is RWO
  strategyType: Recreate # idem
  securityContext:
    fsGroup: 101
  volumeMounts:
    - name: files
      # mountPath: /usr/share/nginx/html
      mountPath: /mnt/files
    - name: nginx-auth
      mountPath: /secrets
project:
  # whitelist:
  #   # DigDash dev
  #   - "94.23.250.213"
  #   # DigDash prod 1 and 2
  #   - "37.187.27.197"
  #   - "37.187.137.149"
  #   - "217.182.225.117"
  #   - "217.182.225.113"
  #   # Invenis prod old and new
  #   - "217.182.142.112"
  #   - "51.38.59.32"
  files:
    public:
      - index-egalite-fh.xlsx
      - dgt-export-representation.xlsx
    restricted:
      - dgt.xlsx
      - dgt-representation.xlsx
      - full.ndjson
      - indexes.csv
