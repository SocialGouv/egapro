---

include:
  - project: SocialGouv/gitlab-ci-yml
    file: /base_register_stage.yml
    ref: master

#
.register_stage: &register_stage
  extends: .base_register_stage
  stage: "Registration"
  except:
    variables:
      - $PRODUCTION
#

#.register_stage commit sha: &register_stage_commit_sha
#  stage: "Registration"
#  image: docker:${DOCKER_VERSION}
#  services:
#    - docker:${DOCKER_VERSION}-dind
#  before_script:
#    - echo "$CI_JOB_TOKEN" | docker login ${CI_REGISTRY} -u gitlab-ci-token --password-stdin
#    - docker pull ${IMAGE_NAME}:${CI_COMMIT_BEFORE_SHA} || true
#  script:
#    - echo "Build ${IMAGE_NAME}:${CI_COMMIT_SHA} from ${IMAGE_NAME}:${CI_COMMIT_BEFORE_SHA}"
#    - docker build --cache-from ${IMAGE_NAME}:${CI_COMMIT_BEFORE_SHA} -t ${IMAGE_NAME}:${CI_COMMIT_SHA} -f ${DOCKERFILE_PATH} ${CONTEXT}
#    - docker push ${IMAGE_NAME}
#

Register api image commit sha:
  <<: *register_stage
  variables:
    CONTEXT: .
    DOCKERFILE_PATH: packages/api/Dockerfile
    IMAGE_NAME: ${CI_REGISTRY_IMAGE}/api

Register app image commit sha:
  <<: *register_stage
  variables:
    CONTEXT: .
    DOCKERFILE_PATH: packages/app/Dockerfile
    IMAGE_NAME: ${CI_REGISTRY_IMAGE}/app

Register init kinto image commit sha:
  <<: *register_stage
  variables:
    CONTEXT: packages/kinto
    DOCKERFILE_PATH: packages/kinto/Dockerfile
    IMAGE_NAME: ${CI_REGISTRY_IMAGE}/kinto

...
